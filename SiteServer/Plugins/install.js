var $ssApi=new apiUtils.Api,$api=new apiUtils.Api(apiUrl+"/pages/plugins/install"),$packageIds=pageUtils.getQueryStringByName("packageIds").split(","),$pageType="true"===pageUtils.getQueryStringByName("isUpdate")?"升级":"安装",data={packageIds:$packageIds,pageLoad:!1,pageAlert:null,pageType:$pageType,pageStep:1,isNightly:!1,version:null,downloadPlugins:null,downloadApi:null,updateApi:null,clearCacheApi:null,listPackages:[],listIndex:0,currentPackage:{},currentPackages:[],currentDownloadingId:0,currentDownloadIds:[],currentUpdatingId:0,currentUpdatedIds:[]},methods={getConfig:function(){var e=this;$api.get(null,function(a,i){!a&&i&&(e.isNightly=i.isNightly,e.version=i.version,e.downloadPlugins=i.downloadPlugins,e.downloadApi=new apiUtils.Api(i.downloadApiUrl),e.updateApi=new apiUtils.Api(i.updateApiUrl),e.clearCacheApi=new apiUtils.Api(i.clearCacheApiUrl),e.getListPackages())},"config")},getListPackages:function(){var e=this;$ssApi.get({isNightly:e.isNightly,version:e.version,$filter:"id in '"+e.packageIds.join(",")+"'"},function(a,i){if(!a&&i&&i.value){for(var t=0;t<i.value.length;t++){var n=i.value[t];e.listPackages.push(n)}e.pageLoad=!0,e.installListPackage()}},"packages")},installListPackage:function(){var e=this;if(e.listIndex!==e.listPackages.length){e.package=e.listPackages[e.listIndex],e.currentPackages.push(e.package);for(var a=[],i=0;i<e.package.pluginReferences.length;i++){var t=e.package.pluginReferences[i];0===$.grep(e.currentPackages,function(e){return e.id==t.id}).length&&a.push(t.id)}for(var n=0;n<e.package.packageReferences.length;n++){var s=e.package.packageReferences[n];0===$.grep(e.currentPackages,function(e){return e.id==s.id}).length&&a.push(s.id)}0!==a.length?$ssApi.get({isNightly:e.isNightly,version:e.version,$filter:"id in '"+a.join(",")+"'"},function(a,i){if(!a&&i&&i.value){for(var t=0;t<i.value.length;t++){for(var n=i.value[t],s=0;s<e.downloadPlugins.length;s++){if(e.downloadPlugins[s]===n.id+"."+n.version){e.currentDownloadIds.push(n.id);break}}e.currentPackages.push(n)}e.download()}},"packages"):e.download()}else e.clearCache()},download:function(){for(var e=0;e<this.currentPackages.length;e++){var a=this.currentPackages[e];if(-1==this.currentDownloadIds.indexOf(a.id))return this.currentDownloadingId=a.id,void this.downloadPackage(a.id,a.version)}this.update()},downloadPackage:function(e,a){var i=this;i.downloadApi.post({packageId:e,version:a},function(a,t){a?i.pageAlert={type:"error",html:a.message}:t&&(i.currentDownloadingId=0,i.currentDownloadIds.push(e),i.download())})},update:function(){this.pageStep=2;for(var e=0;e<this.currentPackages.length;e++){var a=this.currentPackages[e];if(-1==this.currentUpdatedIds.indexOf(a.id))return this.currentUpdatingId=a.id,void this.updatePackage(a.id,a.version,a.packageType)}this.updateSuccess()},updatePackage:function(e,a,i){var t=this;t.updateApi.post({packageId:e,version:a,packageType:i},function(a,i){a?t.pageAlert={type:"error",html:a.message}:i&&(t.currentUpdatingId=0,t.currentUpdatedIds.push(e),t.update())})},updateSuccess:function(){this.listIndex++,this.pageStep=1,this.currentPackage={},this.currentPackages=[],this.currentDownloadingId=0,this.currentDownloadIds=[],this.currentUpdatingId=0,this.currentUpdatedIds=[],this.installListPackage()},clearCache:function(){var e=this;e.pageStep=0,e.clearCacheApi.post(null,function(a,i){a?e.pageAlert={type:"error",html:a.message}:setTimeout(function(){window.top.location.reload(!0)},3e3)})}},$vue=new Vue({el:"#main",data:data,methods:methods});$vue.getConfig();